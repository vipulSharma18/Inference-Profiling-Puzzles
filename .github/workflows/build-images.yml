name: Build Docker Images

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

# Limit concurrency to prevent multiple builds from running simultaneously
# This helps manage GitHub runner memory and storage constraints
concurrency:
  group: docker-builds-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      # Don't cancel other jobs if one fails
      fail-fast: false
      # Use matrix to define the three packages
      matrix:
        package:
          - name: gemlite_autotune
            context: .
            dockerfile: gemlite_autotune/Dockerfile
            image: gemlite-autotune
          - name: torchao_float8
            context: .
            dockerfile: torchao_float8/Dockerfile
            image: torchao-float8
          - name: torchinductor_cudagraph_memory
            context: .
            dockerfile: torchinductor_cudagraph_memory/Dockerfile
            image: torchinductor-cudagraph-memory
      # Limit to 1 concurrent job to manage resources
      max-parallel: 1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          # Enable layer caching
          driver-opts: |
            image=moby/buildkit:latest

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ matrix.package.name }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-${{ matrix.package.name }}-
            ${{ runner.os }}-buildx-

      - name: Cache uv dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: ${{ runner.os }}-uv-${{ matrix.package.name }}-${{ hashFiles(format('{0}/pyproject.toml', matrix.package.name)) }}
          restore-keys: |
            ${{ runner.os }}-uv-${{ matrix.package.name }}-
            ${{ runner.os }}-uv-

      - name: Build Docker image - ${{ matrix.package.name }}
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.package.context }}
          file: ${{ matrix.package.dockerfile }}
          push: false
          tags: ${{ matrix.package.image }}:latest
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max
          # Build arguments for uv cache
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Test Docker image - ${{ matrix.package.name }}
        run: |
          docker run --rm ${{ matrix.package.image }}:latest uv --version
          docker run --rm ${{ matrix.package.image }}:latest python3.12 --version

      # Move cache to avoid growing cache size indefinitely
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Clean up Docker resources
        if: always()
        run: |
          docker system prune -af --volumes
          df -h

